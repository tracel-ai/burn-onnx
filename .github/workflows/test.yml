name: CI

on:
  push:
    branches:
      - main
    paths:
      - 'Cargo.lock'
      - '**.rs'
      - '**.sh'
      - '**.ps1'
      - '**.yml'
      - '**.toml'
      - '!**.md'
      - '!LICENSE-APACHE'
      - '!LICENSE-MIT'
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'Cargo.lock'
      - '**.rs'
      - '**.sh'
      - '**.ps1'
      - '**.yml'
      - '**.toml'
      - '!**.md'
      - '!LICENSE-APACHE'
      - '!LICENSE-MIT'

env:
  RUST_PREVIOUS_VERSION: 1.92.0
  # Test in release mode (make it an empty string to test in debug mode)
  TEST_RELEASE_FLAG: "--release"
  # Model-checks require externally downloaded ONNX files not available in CI
  MODEL_CHECKS_EXCLUDE: "burn-onnx-model-checks-*,model-checks-common"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare-checks:
    runs-on: ubuntu-latest
    outputs:
      rust-prev-version: ${{ env.RUST_PREVIOUS_VERSION }}
    steps:
      - name: Do Nothing
        if: false
        run: echo

  code-quality:
    runs-on: ubuntu-22.04
    needs: prepare-checks
    strategy:
      matrix:
        rust: [stable]
        include:
          - rust: stable
            toolchain: stable
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      # --------------------------------------------------------------------------------
      - name: Install Rust
        uses: tracel-ai/github-actions/install-rust@v9
        with:
          rust-toolchain: ${{ matrix.toolchain }}
          cache-key: ${{ matrix.rust }}-linux
      # --------------------------------------------------------------------------------
      - name: Audit
        run: xtask check audit
      # --------------------------------------------------------------------------------
      - name: Format
        shell: bash
        env:
          # work around for colors
          # see: https://github.com/rust-lang/rustfmt/issues/3385
          TERM: xterm-256color
        run: xtask check format
      # --------------------------------------------------------------------------------
      - name: Lint
        run: xtask check lint
      # --------------------------------------------------------------------------------
      - name: Typos
        uses: tracel-ai/github-actions/check-typos@v9

  documentation:
    runs-on: ubuntu-22.04
    needs: prepare-checks
    strategy:
      matrix:
        rust: [stable]
        include:
          - rust: stable
            toolchain: stable
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      # --------------------------------------------------------------------------------
      - name: Install Rust
        uses: tracel-ai/github-actions/install-rust@v9
        with:
          rust-toolchain: ${{ matrix.toolchain }}
          cache-key: ${{ matrix.rust }}-linux
      # --------------------------------------------------------------------------------
      - name: Documentation Build
        run: cargo doc --workspace --no-deps --color=always --exclude 'burn-onnx-model-checks-*' --exclude model-checks-common
      # --------------------------------------------------------------------------------
      - name: Documentation Tests
        run: cargo test --workspace --doc --color always --exclude 'burn-onnx-model-checks-*' --exclude model-checks-common

  linux-std-tests:
    runs-on: ubuntu-22.04
    needs: [prepare-checks, code-quality]
    env:
      DISABLE_WGPU_SPIRV: '1'
      # disable incremental compilation (reduces artifact size)
      CARGO_PROFILE_TEST_INCREMENTAL: 'false'
    strategy:
      matrix:
        rust: [stable, prev]
        include:
          - rust: stable
            toolchain: stable
            # coverage: --enable-coverage
          - rust: prev
            toolchain: ${{ needs.prepare-checks.outputs.rust-prev-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      # --------------------------------------------------------------------------------
      - name: Install Rust
        uses: tracel-ai/github-actions/install-rust@v9
        with:
          rust-toolchain: ${{ matrix.toolchain }}
          cache-key: ${{ matrix.rust }}-linux
          # Disable cache on linux-std (stable) runner which currently always runs out of disk space with tests + coverage
          enable-cache: ${{ matrix.rust != 'stable' }}
      - name: Tests
        run: xtask test ${{ env.TEST_RELEASE_FLAG }} -x ${{ env.MODEL_CHECKS_EXCLUDE }}

  linux-no-std-tests:
    runs-on: ubuntu-22.04
    needs: [prepare-checks, code-quality]
    strategy:
      matrix:
        rust: [stable, prev]
        include:
          - rust: stable
            toolchain: stable
          - rust: prev
            toolchain: ${{ needs.prepare-checks.outputs.rust-prev-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      # --------------------------------------------------------------------------------
      - name: Install Rust
        uses: tracel-ai/github-actions/install-rust@v9
        with:
          rust-toolchain: ${{ matrix.toolchain }}
          cache-key: ${{ matrix.rust }}-linux-no-std
      # --------------------------------------------------------------------------------
      - name: Crates Build
        run: xtask --context no-std build -x ${{ env.MODEL_CHECKS_EXCLUDE }}
      # --------------------------------------------------------------------------------
      - name: Crates Tests
        run: xtask --context no-std test ${{ env.TEST_RELEASE_FLAG }} -x ${{ env.MODEL_CHECKS_EXCLUDE }}

  windows-std-tests:
    runs-on: windows-2022
    needs: [prepare-checks, code-quality]
    # Keep the stragegy to be able to easily add new rust versions if required
    strategy:
      matrix:
        rust: [stable]
        include:
          - rust: stable
            toolchain: stable
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      # --------------------------------------------------------------------------------
      - name: Install Rust
        uses: tracel-ai/github-actions/install-rust@v9
        with:
          rust-toolchain: ${{ matrix.toolchain }}
          cache-key: ${{ matrix.rust }}-windows
      # --------------------------------------------------------------------------------
      - name: Tests
        run: xtask test ${{ env.TEST_RELEASE_FLAG }} -x ${{ env.MODEL_CHECKS_EXCLUDE }}
